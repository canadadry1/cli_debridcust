{% extends "base.html" %}

{% block title %}Manual Blacklist{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/manual_blacklist.css') }}">
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manual Blacklist</h2>
    </div>

    <form action="{{ url_for('debug.manual_blacklist') }}" method="POST" class="mb-4" id="blacklistForm">
        <div class="input-group">
            <div class="input-group-prepend">
                <label class="input-group-text" for="imdb_id">IMDb ID:</label>
            </div>
            <input type="text" id="imdb_id" name="imdb_id" required class="form-control">
            <input type="hidden" name="action" value="add">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add to Blacklist
            </button>
            <button type="button" id="saveAllChanges" class="btn btn-primary">
                <i class="fas fa-save"></i> Save All Changes
            </button>
        </div>
    </form>

    <h3>Current Blacklist</h3>
    <table class="table">
        <thead>
            <tr>
                <th>IMDb ID</th>
                <th>Title</th>
                <th>Year</th>
                <th>Media Type</th>
                <th>Seasons</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for imdb_id, item in blacklist.items() %}
            <tr>
                <td>{{ imdb_id }}</td>
                <td>{{ item.title }}</td>
                <td>{{ item.year }}</td>
                <td>{{ item.media_type }}</td>
                <td>
                    {% if item.media_type == 'episode' %}
                        <form class="seasons-form" data-imdb-id="{{ imdb_id }}">
                            <div class="form-check mb-2 d-flex align-items-center">
                                <input type="checkbox" class="form-check-input select-all" id="all_{{ imdb_id }}" 
                                       name="all_seasons" {% if not item.seasons %}checked{% endif %}>
                                <label class="form-check-label" for="all_{{ imdb_id }}">All Seasons</label>
                                <a href="#" class="toggle-seasons text-secondary ms-2" title="Toggle Seasons">
                                    <i class="fas fa-chevron-down"></i>
                                </a>
                            </div>
                            <div class="seasons-container">
                                <div class="seasons-list" style="display: none;">
                                    {% for season in range(1, 21) %}
                                    <div class="form-check season-check">
                                        <input type="checkbox" class="form-check-input season-checkbox" 
                                               name="seasons" value="{{ season }}" id="season_{{ imdb_id }}_{{ season }}"
                                               data-season="{{ season }}"
                                               {% if item.seasons and season in item.seasons %}checked{% endif %}>
                                        <label class="form-check-label" for="season_{{ imdb_id }}_{{ season }}">
                                            Season {{ season }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </form>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <form action="{{ url_for('debug.manual_blacklist') }}" method="POST" class="d-inline">
                        <input type="hidden" name="action" value="remove">
                        <input type="hidden" name="imdb_id" value="{{ imdb_id }}">
                        <button type="submit" class="btn btn-link text-danger p-0">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6">No items in the blacklist</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
.seasons-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin: 10px 0;
}
.form-check {
    margin-bottom: 5px;
}
.season-check {
    margin-left: 20px;
}
.seasons-container {
    margin-top: 10px;
}
.toggle-seasons {
    text-decoration: none;
}
.toggle-seasons:hover {
    text-decoration: none;
}
.toggle-seasons.active i {
    transform: rotate(180deg);
}
.btn-link:hover {
    text-decoration: none;
}
.ms-2 {
    margin-left: 0.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle "All Seasons" checkboxes
    document.querySelectorAll('.select-all').forEach(checkbox => {
        const form = checkbox.closest('form');
        const seasonsList = form.querySelector('.seasons-list');
        const seasonChecks = form.querySelectorAll('.season-checkbox');
        
        checkbox.addEventListener('change', function() {
            seasonsList.style.display = this.checked ? 'none' : 'block';
            if (this.checked) {
                seasonChecks.forEach(check => check.checked = false);
            }
        });
    });

    // Handle toggle buttons
    document.querySelectorAll('.toggle-seasons').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const seasonsList = this.closest('.seasons-form').querySelector('.seasons-list');
            const isHidden = seasonsList.style.display === 'none';
            seasonsList.style.display = isHidden ? 'block' : 'none';
            this.classList.toggle('active');
        });
    });

    // Handle shift-click selection
    let lastChecked = null;
    document.querySelectorAll('.season-checkbox').forEach(checkbox => {
        checkbox.addEventListener('click', function(e) {
            if (!lastChecked) {
                lastChecked = this;
                return;
            }

            if (e.shiftKey) {
                const checkboxes = Array.from(this.closest('.seasons-list').querySelectorAll('.season-checkbox'));
                const start = checkboxes.indexOf(this);
                const end = checkboxes.indexOf(lastChecked);
                
                const shouldCheck = this.checked;
                
                checkboxes
                    .slice(Math.min(start, end), Math.max(start, end) + 1)
                    .forEach(cb => cb.checked = shouldCheck);
            }

            lastChecked = this;
        });
    });

    // Handle save all changes
    document.getElementById('saveAllChanges').addEventListener('click', async function() {
        const forms = document.querySelectorAll('.seasons-form');
        for (const form of forms) {
            const imdbId = form.dataset.imdbId;
            const allSeasons = form.querySelector('.select-all').checked;
            const selectedSeasons = Array.from(form.querySelectorAll('.season-checkbox:checked')).map(cb => cb.value);
            
            const formData = new FormData();
            formData.append('action', 'update_seasons');
            formData.append('imdb_id', imdbId);
            if (allSeasons) {
                formData.append('all_seasons', 'on');
            } else {
                selectedSeasons.forEach(season => formData.append('seasons', season));
            }
            
            try {
                await fetch("{{ url_for('debug.manual_blacklist') }}", {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Error saving changes:', error);
            }
        }
        
        // Reload the page to show updated state
        window.location.reload();
    });
});
</script>
{% endblock %}