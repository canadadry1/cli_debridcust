<h3>Required Settings</h3>
<div class="settings-expand-collapse-buttons">
    <button type="button" class="settings-expand-all">Expand All</button>
    <button type="button" class="settings-collapse-all">Collapse All</button>
</div>

<div class="settings-section">
    <div class="settings-section-header">
        <h4>Debrid Provider</h4>
        <span class="settings-toggle-icon">+</span>
    </div>
    <div class="settings-section-content">
        {% for key, value in settings_schema['Debrid Provider'].items() %}
            {% if key != 'tab' %}
            <div class="settings-form-group">
                <label for="debrid provider-{{ key }}" class="settings-title">{{ key|replace('_', ' ')|title }}:</label>
                {% if value.type == 'boolean' %}
                    <input type="checkbox" id="debrid provider-{{ key }}" name="Debrid Provider.{{ key }}" 
                           data-section="Debrid Provider" data-key="{{ key }}"
                           {% if settings.get('Debrid Provider', {}).get(key) %}checked{% endif %}>
                {% elif value.choices %}
                    <select id="debrid provider-{{ key }}" name="Debrid Provider.{{ key }}" class="settings-input"
                            data-section="Debrid Provider" data-key="{{ key }}">
                        {% for choice in value.choices %}
                            <option value="{{ choice }}" {% if settings.get('Debrid Provider', {}).get(key) == choice %}selected{% endif %}>{{ choice }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="{{ value.type }}" id="debrid provider-{{ key }}" name="Debrid Provider.{{ key }}" 
                           value="{{ settings.get('Debrid Provider', {}).get(key, '') }}" class="settings-input"
                           data-section="Debrid Provider" data-key="{{ key }}"
                           {% if value.sensitive %}type="password"{% endif %}>
                {% endif %}
                {% if value.description %}
                    <p class="settings-description">{{ value.description }}</p>
                {% endif %}
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<div class="settings-section">
    <div class="settings-section-header">
        <h4>File Management</h4>
        <span class="settings-toggle-icon">+</span>
    </div>
    <div class="settings-section-content">
        {% for key, value in settings_schema['File Management'].items() %}
            {% if key != 'tab' and key != 'symlink_organize_by_type' %}
            <div class="settings-form-group {% if key in ['plex_url_for_symlink', 'plex_token_for_symlink'] %}symlink-plex-setting{% endif %}">
                <label for="file management-{{ key }}" class="settings-title">{{ key|replace('_', ' ')|title }}:</label>
                {% if value.type == 'boolean' %}
                    <input type="checkbox" id="file management-{{ key }}" name="File Management.{{ key }}"
                           data-section="File Management" data-key="{{ key }}"
                           {% if settings.get('File Management', {}).get(key) %}checked{% endif %}>
                {% elif value.choices %}
                    <select id="file management-{{ key }}" name="File Management.{{ key }}" class="settings-input"
                            data-section="File Management" data-key="{{ key }}"
                            {% if key == 'file_collection_management' %}data-previous-value="{{ settings.get('File Management', {}).get(key, '') }}"{% endif %}>
                        {% for choice in value.choices %}
                            <option value="{{ choice }}" {% if settings.get('File Management', {}).get(key) == choice %}selected{% endif %}>{{ choice }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="{{ value.type }}" id="file management-{{ key }}" name="File Management.{{ key }}"
                           value="{{ settings.get('File Management', {}).get(key, '') }}" class="settings-input"
                           data-section="File Management" data-key="{{ key }}"
                           {% if value.sensitive %}type="password"{% endif %}>
                {% endif %}
                {% if value.description %}
                    <p class="settings-description">{{ value.description }}</p>
                {% endif %}
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Always include Plex section but initially hidden -->
<div class="settings-section" id="plex-settings-section" style="display: none;">
    <div class="settings-section-header">
        <h4>Plex</h4>
        <span class="settings-toggle-icon">+</span>
    </div>
    <div class="settings-section-content">
        {% for key, value in settings_schema['Plex'].items() %}
            {% if key != 'tab' %}
            <div class="settings-form-group">
                <label for="plex-{{ key }}" class="settings-title">{{ key|replace('_', ' ')|title }}:</label>
                {% if value.type == 'boolean' %}
                    <input type="checkbox" id="plex-{{ key }}" name="Plex.{{ key }}"
                           data-section="Plex" data-key="{{ key }}"
                           {% if settings.get('Plex', {}).get(key) %}checked{% endif %}>
                {% elif value.choices %}
                    <select id="plex-{{ key }}" name="Plex.{{ key }}" class="settings-input"
                            data-section="Plex" data-key="{{ key }}">
                        {% for choice in value.choices %}
                            <option value="{{ choice }}" {% if settings.get('Plex', {}).get(key) == choice %}selected{% endif %}>{{ choice }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="{{ value.type }}" id="plex-{{ key }}" name="Plex.{{ key }}"
                           value="{{ settings.get('Plex', {}).get(key, '') }}" class="settings-input"
                           data-section="Plex" data-key="{{ key }}"
                           {% if key in ['movie_libraries', 'shows_libraries'] %}data-plex-required="true"{% endif %}
                           {% if key == 'disable_plex_library_checks' %}data-plex-required="true"{% endif %}
                           {% if value.sensitive %}type="password"{% endif %}>
                {% endif %}
                {% if value.description %}
                    <p class="settings-description">{{ value.description }}</p>
                {% endif %}
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<div class="settings-section">
    <div class="settings-section-header">
        <h4>Trakt</h4>
        <span class="settings-toggle-icon">+</span>
    </div>
    <div class="settings-section-content">
        <p class="settings-description">Please create an application at <a href="https://trakt.tv/oauth/applications/">Trakt Applications</a> if you have not yet done so. All you need to add is a <b>Name</b>, and the <b>Redirect URI</b> which is:</p> 
        <code><b>urn:ietf:wg:oauth:2.0:oob</b></code><br>
        <br>
        {% for key, value in settings_schema['Trakt'].items() %}
            {% if key != 'tab' %}
            <div class="settings-form-group">
                <label for="trakt-{{ key }}" class="settings-title">{{ key|replace('_', ' ')|title }}:</label>
                {% if value.type == 'boolean' %}
                    <input type="checkbox" id="trakt-{{ key }}" name="Trakt.{{ key }}"
                           data-section="Trakt" data-key="{{ key }}"
                           {% if settings.get('Trakt', {}).get(key) %}checked{% endif %}>
                {% elif value.choices %}
                    <select id="trakt-{{ key }}" name="Trakt.{{ key }}" class="settings-input"
                            data-section="Trakt" data-key="{{ key }}">
                        {% for choice in value.choices %}
                            <option value="{{ choice }}" {% if settings.get('Trakt', {}).get(key) == choice %}selected{% endif %}>{{ choice }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="{{ value.type }}" id="trakt-{{ key }}" name="Trakt.{{ key }}"
                           value="{{ settings.get('Trakt', {}).get(key, '') }}" class="settings-input"
                           data-section="Trakt" data-key="{{ key }}"
                           {% if value.sensitive %}type="password"{% endif %}>
                {% endif %}
                {% if value.description %}
                    <p class="settings-description">{{ value.description }}</p>
                {% endif %}
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Trakt Authorization Section -->
<div class="settings-section">
    <div class="settings-section-header">
        <h4>Trakt Authorization</h4>
        <span class="settings-toggle-icon">+</span>
    </div>
    <div class="settings-section-content">
        <p class="settings-description">Click the button below to authorize Trakt. You must first have entered your Client ID and Client Secret above (after creating an application).</p>
        <button id="trakt-auth-btn" class="settings-button">Authorize Trakt</button>
        <div id="trakt-auth-status" class="trakt-status"></div>
        <div id="trakt-auth-code" class="trakt-auth-code" style="display: none;">
            <p>Your authorization code is: <strong id="trakt-code"></strong></p>
            <p>Please visit <a id="trakt-activate-link" href="https://trakt.tv/activate" target="_blank">https://trakt.tv/activate</a> to enter this code and complete the authorization process.</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get the elements
    const updatePlexOnDiscovery = document.getElementById('plex-update_plex_on_file_discovery');
    const disablePlexChecks = document.getElementById('plex-disable_plex_library_checks');

    // Function to handle mutual exclusivity
    function handlePlexSettingsChange(event) {
        if (event.target === disablePlexChecks) {
            if (disablePlexChecks.checked) {
                // If disable checks is enabled, disable the other one
                updatePlexOnDiscovery.checked = false;
            }
        } else {
            // If either of the first two are modified
            if (updatePlexOnDiscovery.checked) {
                disablePlexChecks.checked = false;
            }
        }
    }

    // Add event listeners
    updatePlexOnDiscovery.addEventListener('change', handlePlexSettingsChange);
    disablePlexChecks.addEventListener('change', handlePlexSettingsChange);
});
</script>

<script type="module">
import { showPopup, POPUP_TYPES } from '/static/js/notifications.js';

document.addEventListener('DOMContentLoaded', function() {
    // Get the file collection management select element
    const collectionTypeSelect = document.querySelector('select[name="File Management.file_collection_management"]');
    
    if (collectionTypeSelect) {
        // Initial UI setup based on current value
        updateUIVisibility(collectionTypeSelect.value);
        
        collectionTypeSelect.addEventListener('change', async function(event) {
            // Prevent any immediate changes
            event.preventDefault();
            event.stopPropagation();
            
            const previousValue = this.getAttribute('data-previous-value');
            const newValue = this.value;
            
            // Immediately set back to previous value to prevent UI flicker
            this.value = previousValue;
            
            if (previousValue !== newValue) {
                showPopup({
                    type: POPUP_TYPES.CONFIRM,
                    title: '⚠️ Change Collection Management Type',
                    message: 'Changing between Plex and Symlinked/Local management is an advanced process that may affect your existing library structure. Are you sure you want to proceed?',
                    confirmText: 'Yes, Change',
                    cancelText: 'No, Keep Current',
                    onConfirm: () => {
                        // Update the select value
                        this.value = newValue;
                        
                        // Update the previous value attribute
                        this.setAttribute('data-previous-value', newValue);
                        
                        // Manually trigger the settings change event for the UI
                        const event = new CustomEvent('settings-changed', {
                            detail: {
                                section: 'File Management',
                                key: 'file_collection_management',
                                value: newValue
                            }
                        });
                        document.dispatchEvent(event);
                        
                        // Update UI based on the new value
                        updateUIVisibility(newValue);
                    },
                    onCancel: () => {
                        // Value is already set back to previous, no need to do anything
                    }
                });
            }
        });
    }
    
    // Function to update UI visibility
    function updateUIVisibility(value) {
        const plexSection = document.getElementById('plex-settings-section');
        const symlinkFields = [
            document.querySelector('div.settings-form-group:has(#file\\ management-original_files_path)'),
            document.querySelector('div.settings-form-group:has(#file\\ management-symlinked_files_path)'),
            document.querySelector('div.settings-form-group:has(#file\\ management-plex_url_for_symlink)'),
            document.querySelector('div.settings-form-group:has(#file\\ management-plex_token_for_symlink)')
        ];

        if (value === 'Plex') {
            // Show Plex section
            plexSection.style.display = 'block';
            // Hide symlink fields
            symlinkFields.forEach(field => {
                if (field) field.style.display = 'none';
            });
        } else {
            // Hide Plex section
            plexSection.style.display = 'none';
            // Show symlink fields
            symlinkFields.forEach(field => {
                if (field) field.style.display = 'block';
            });
        }
    }
});
</script>
