{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Performance Dashboard</h2>
    
    <div class="row">
        <!-- System Resources -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-microchip"></i> System Resources
                </div>
                <div class="card-body">
                    <div id="system-resources">
                        <div class="mb-3">
                            <h5><i class="fas fa-tachometer-alt"></i> CPU Usage</h5>
                            <div class="progress mb-2">
                                <div id="cpu-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="cpu-details" class="small text-muted"></div>
                        </div>
                        
                        <div class="mb-3">
                            <h5><i class="fas fa-memory"></i> Memory Usage</h5>
                            <div class="progress mb-2">
                                <div id="memory-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="memory-details" class="small text-muted"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Memory Analysis -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i> Memory Analysis
                </div>
                <div class="card-body">
                    <div id="memory-analysis">
                        <h6>Top Memory Users by Type</h6>
                        <div id="memory-by-type" class="small"></div>
                        
                        <h6 class="mt-3">Top Memory Users by Module</h6>
                        <div id="memory-by-module" class="small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Memory Growth -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i> Memory Growth
                </div>
                <div class="card-body">
                    <div id="memory-growth" class="small"></div>
                </div>
            </div>
        </div>
        
        <!-- Resource Handles -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-plug"></i> Resource Handles
                </div>
                <div class="card-body">
                    <div id="resource-handles" class="small"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
}

function updateDashboard() {
    fetch('/performance/api/performance/log')
        .then(response => response.json())
        .then(data => {
            if (data.sections) {
                // Update System Resources
                const systemResources = data.sections['📊 SYSTEM RESOURCES'] || [];
                systemResources.forEach(line => {
                    if (line.includes('CPU')) {
                        const cpuMatch = line.match(/Current Usage:\s*([\d.]+)%/);
                        if (cpuMatch) {
                            const cpuPercent = parseFloat(cpuMatch[1]);
                            document.getElementById('cpu-progress').style.width = `${cpuPercent}%`;
                            document.getElementById('cpu-details').innerHTML = line.replace('Current Usage:', '<strong>Current Usage:</strong>');
                        }
                    }
                    if (line.includes('MEMORY')) {
                        const memoryMatch = line.match(/System Used:\s*([\d.]+)%/);
                        if (memoryMatch) {
                            const memoryPercent = parseFloat(memoryMatch[1]);
                            document.getElementById('memory-progress').style.width = `${memoryPercent}%`;
                            document.getElementById('memory-details').innerHTML = line.replace('System Used:', '<strong>System Used:</strong>');
                        }
                    }
                });

                // Update Memory Analysis
                const memoryAnalysis = data.sections['🔍 MEMORY ANALYSIS'] || [];
                let byTypeHtml = '';
                let byModuleHtml = '';
                
                memoryAnalysis.forEach(line => {
                    if (line.includes('Top Memory Users by Type')) {
                        const nextIndex = memoryAnalysis.indexOf(line) + 1;
                        for (let i = nextIndex; i < memoryAnalysis.length && !memoryAnalysis[i].includes('Top Memory Users by Module'); i++) {
                            if (memoryAnalysis[i].trim()) {
                                byTypeHtml += `<div>${memoryAnalysis[i]}</div>`;
                            }
                        }
                    }
                    if (line.includes('Top Memory Users by Module')) {
                        const nextIndex = memoryAnalysis.indexOf(line) + 1;
                        for (let i = nextIndex; i < memoryAnalysis.length && !memoryAnalysis[i].includes('Top Memory Users by Function'); i++) {
                            if (memoryAnalysis[i].trim()) {
                                byModuleHtml += `<div>${memoryAnalysis[i]}</div>`;
                            }
                        }
                    }
                });
                
                document.getElementById('memory-by-type').innerHTML = byTypeHtml;
                document.getElementById('memory-by-module').innerHTML = byModuleHtml;

                // Update Memory Growth
                const memoryGrowth = data.sections['📈 MEMORY GROWTH'] || [];
                let growthHtml = '';
                memoryGrowth.forEach(line => {
                    if (line.includes('Top Memory Allocations by Location')) {
                        const nextIndex = memoryGrowth.indexOf(line) + 1;
                        for (let i = nextIndex; i < memoryGrowth.length; i++) {
                            if (memoryGrowth[i].trim()) {
                                growthHtml += `<div>${memoryGrowth[i]}</div>`;
                            }
                        }
                    }
                });
                document.getElementById('memory-growth').innerHTML = growthHtml;

                // Update Resource Handles
                const resourceHandles = data.sections['🔌 RESOURCE HANDLES'] || [];
                let handlesHtml = '';
                resourceHandles.forEach(line => {
                    if (line.trim()) {
                        handlesHtml += `<div>${line}</div>`;
                    }
                });
                document.getElementById('resource-handles').innerHTML = handlesHtml;
            }
        })
        .catch(error => console.error('Error fetching performance log:', error));
}

// Update dashboard every 5 seconds
setInterval(updateDashboard, 5000);
// Initial update
updateDashboard();
</script>
{% endblock %}