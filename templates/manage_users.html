{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}
{% block content %}
<style>
    /* Manage Users styles */
    .manage-users {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .user-list {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .user-list th, .user-list td {
        padding: 10px;
        border: 1px solid #555;
        text-align: left;
    }

    .user-list th {
        background-color: #2a2a2a;
        color: #f4f4f4;
    }

    .user-list tr:nth-child(even) {
        background-color: #333;
    }

    .add-user-form {
        margin-top: 30px;
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 5px;
    }

    .add-user-form h3 {
        margin-top: 0;
        color: #f4f4f4;
    }

    .add-user-form input[type="text"],
    .add-user-form input[type="password"],
    .add-user-form select {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #555;
        border-radius: 3px;
        background-color: #333;
        color: #f4f4f4;
        font-size: 16px;
        box-sizing: border-box;
    }

    .add-user-form input[type="submit"] {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 3px;
        background-color: #4CAF50;
        color: white;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }

    .delete-button {
        background-color: #f44336;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
    }

    .change-password-button {
        background-color: #ff9800;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .add-user-form input[type="submit"]:hover {
        background-color: #45a049;
    }

    /* Password change modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: #2a2a2a;
        margin: 15% auto;
        padding: 20px;
        border-radius: 5px;
        width: 80%;
        max-width: 500px;
    }

    .modal-content h3 {
        margin-top: 0;
        color: #f4f4f4;
    }

    .modal-content input[type="password"] {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #555;
        border-radius: 3px;
        background-color: #333;
        color: #f4f4f4;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .modal-buttons button {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .modal-cancel {
        background-color: #666;
        color: white;
    }

    .modal-save {
        background-color: #4CAF50;
        color: white;
    }

    /* Add styles for the key management section */
    .key-info {
        color: #888;
        font-size: 0.9em;
        margin-top: 10px;
        font-style: italic;
    }
</style>

<div class="manage-users">
    <h2>Manage Users</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
                <li class="flash-message {{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}
    <table class="user-list">
        <thead>
            <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr data-user-id="{{ user.id }}">
                <td>{{ user.username }}</td>
                <td>{{ user.role }}</td>
                <td>
                    <button class="change-password-button" data-user-id="{{ user.id }}" data-username="{{ user.username }}">Change Password</button>
                    {% if user.role == 'admin' %}
                        {% set admin_count = users|selectattr('role', 'equalto', 'admin')|list|length %}
                        {% if admin_count > 1 %}
                            <button class="delete-button" data-user-id="{{ user.id }}">Delete</button>
                        {% else %}
                            <span style="font-style: italic;">Cannot Delete</span>
                        {% endif %}
                    {% else %}
                        <button class="delete-button" data-user-id="{{ user.id }}">Delete</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="add-user-form">
        <h3>Add New User</h3>
        <form action="{{ url_for('user_management.add_user') }}" method="POST">
            <input type="text" name="username" placeholder="Username" required autocomplete="new-username">
            <input type="password" name="password" placeholder="Password" required autocomplete="new-password">
            <select name="role" required>
                <option value="user">User</option>
                <option value="admin">Admin</option>
            </select>
            <input type="submit" value="Add User">
        </form>
    </div>

    <!-- Add Registration Key Management Section -->
    <div class="add-user-form">
        <h3>Registration Key Management</h3>
        <form action="{{ url_for('user_management.update_registration_key') }}" method="POST">
            <input type="text" name="registration_key" placeholder="Registration Key" value="{{ registration_key.key if registration_key else '' }}" required>
            <input type="number" name="registration_key_limit" placeholder="Key Usage Limit (empty for unlimited)" value="{{ registration_key.limit if registration_key and registration_key.limit else '' }}" min="1">
            <input type="submit" value="Update Registration Key">
        </form>
        {% if registration_key and registration_key.key %}
            <p class="key-info">
                This key will be required for new users to register their own accounts.<br>
                Current usage: {{ registration_key.used }} {% if registration_key.limit %}/ {{ registration_key.limit }}{% endif %}
                {% if registration_key.limit and registration_key.used >= registration_key.limit %}
                    <br><span style="color: #ff6b6b;">(Key limit reached)</span>
                {% endif %}
            </p>
        {% else %}
            <p class="key-info">This key will be required for new users to register their own accounts.</p>
        {% endif %}
    </div>
</div>

<!-- Password Change Modal -->
<div id="passwordChangeModal" class="modal">
    <div class="modal-content">
        <h3>Change Password for <span id="modalUsername"></span></h3>
        <form id="passwordChangeForm">
            <input type="password" id="newPassword" name="new_password" placeholder="New Password" required>
            <div class="modal-buttons">
                <button type="button" class="modal-cancel">Cancel</button>
                <button type="submit" class="modal-save">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
import { showPopup, POPUP_TYPES } from '/static/js/notifications.js';

document.addEventListener('DOMContentLoaded', function() {
    // Add user form handling
    const addUserForm = document.querySelector('.add-user-form form');
    addUserForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const username = formData.get('username');
        const role = formData.get('role');

        showPopup({
            type: POPUP_TYPES.CONFIRM,
            title: "Add User",
            message: `Are you sure you want to add user "${username}" with role "${role}"?`,
            onConfirm: function() {
                fetch("{{ url_for('user_management.add_user') }}", {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        showPopup({
                            type: POPUP_TYPES.ERROR,
                            title: 'Error',
                            message: data.error || 'An error occurred while adding the user.'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showPopup({
                        type: POPUP_TYPES.ERROR,
                        title: 'Error',
                        message: 'An unexpected error occurred.'
                    });
                });
            }
        });
    });

    // Delete user handling
    document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            showPopup({
                type: POPUP_TYPES.CONFIRM,
                title: "Delete User",
                message: "Are you sure you want to delete this user?",
                onConfirm: function() {
                    fetch(`/user_management/delete_user/${userId}`, {
                        method: 'POST',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            showPopup({
                                type: POPUP_TYPES.ERROR,
                                message: 'Error deleting user: ' + (data.error || 'Unknown error'),
                                title: 'Error'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showPopup({
                            type: POPUP_TYPES.ERROR,
                            message: 'Error deleting user',
                            title: 'Error'
                        });
                    });
                }
            });
        });
    });

    // Password change modal handling
    const modal = document.getElementById('passwordChangeModal');
    const modalUsername = document.getElementById('modalUsername');
    const passwordChangeForm = document.getElementById('passwordChangeForm');
    let currentUserId = null;

    // Open modal
    document.querySelectorAll('.change-password-button').forEach(button => {
        button.addEventListener('click', function() {
            currentUserId = this.dataset.userId;
            modalUsername.textContent = this.dataset.username;
            modal.style.display = 'block';
        });
    });

    // Close modal
    document.querySelector('.modal-cancel').addEventListener('click', function() {
        modal.style.display = 'none';
        passwordChangeForm.reset();
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
            passwordChangeForm.reset();
        }
    });

    // Handle password change submission
    passwordChangeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        showPopup({
            type: POPUP_TYPES.CONFIRM,
            title: "Change Password",
            message: "Are you sure you want to change this user's password?",
            onConfirm: function() {
                fetch(`/user_management/change_user_password/${currentUserId}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        modal.style.display = 'none';
                        passwordChangeForm.reset();
                        showPopup({
                            type: POPUP_TYPES.SUCCESS,
                            title: 'Success',
                            message: 'Password changed successfully'
                        });
                    } else {
                        showPopup({
                            type: POPUP_TYPES.ERROR,
                            title: 'Error',
                            message: data.error || 'An error occurred while changing the password.'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showPopup({
                        type: POPUP_TYPES.ERROR,
                        title: 'Error',
                        message: 'An unexpected error occurred.'
                    });
                });
            }
        });
    });
});
</script>
{% endblock %}